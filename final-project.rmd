---
title: "Exploring the Expedia Recommendation Algorithm"
author: 'Group 35: Max Ming Yi Koh (1007972785) and Kevin Le (1007952805)'
date: "March 31, 2022"
output:
  beamer_presentation:
    theme: Pittsburgh
    colortheme: orchid
    fonttheme: structurebold
    slide_level: 2
  pdf_document: default
classoption: aspectratio=169
fontsize: 11pt
urlcolor: blue
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# echo=FALSE will stop the code chunk from appearing in the knit document
# warning=FALSE and message=FALSE will stop R messages from appearing in the knit document
library(tidyverse)
library(dplyr)
# here is the data for this project
expedia_data <- read_csv("ExpediaSearchData.csv")
# see the Project Overview page for more information: 
# https://q.utoronto.ca/courses/235890/pages/project-overview
```

## General Motivations
Expedia is a website that generates revenue by reselling bookings (purchased in bulk at discounted pricing) or by earning commissions from hoteliers. Thus, an effective recommendation algorithm that recognizes consumer needs is crucial to optimize Expedia's user experience and result in a better bottom line. 

Thus, this leads to the investigation of the quality of Expedia's recommendation algorithm and how various factors can affect purchasing decisions of consumers. This will be explored by probing into 3 research questions. 

The dataset provided includes data of 1,000 consumer searches along with details of some common search filters during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021. So, the sample of the research consists of these 1,000 consumer searches while the population of the research consists of all consumers that made an Expedia search during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021.

## Data Summary
Below is a table of variables used in all 3 research problems. Note that {n} is a placeholder for values 1, 2, or 3. 
 
| Variable      | Description                                                           |
|---------------|-----------------------------------------------------------------------|
| is_trans{n}   | describes whether the consumer transacted the n-th displayed property |
| is_drr{n}     | describes whether the n-th displayed property is discounted           |
| num_clicks{n} | number of clicks for the n-th displayed property                      |
| checkin_date  | stay start date                                                       |
| checkout_date | stay end date                                                         |
| adult_count   | number of adults on the trip                                          |
| child_count   | number of children on the trip                                        |


## Research Question 1
**Research Question**: What is the proportion of consumers during June $1^{st}$, 2021 and July $31^{st}$, 2021 that purchase one of the top 3 recommended properties? 

**Research Motivation**: The proportion of consumers who purchase one of the top 3 recommended properties is a good metric to measure the effectiveness of Expedia's recommendation algorithm. A higher proportion implies the algoirthm is effective at recognizing consumer needs while a lower proportion implies the algorithm is less effective at recognizing consumer needs. 

## Visualization 1
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
expedia_data_q1 <- expedia_data %>% 
  select(is_trans1, is_trans2, is_trans3) %>% 
  mutate(is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0),
         is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0),
         is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0), 
         trans_made = ifelse(is_trans1 + is_trans2 + is_trans3 > 0, TRUE, FALSE)
  ) 

expedia_data_q1 %>%  
  ggplot(aes(x=trans_made)) + 
  geom_bar(color="black", fill="gray") + 
  labs(x="Transaction Made By Consumer", 
       y="Count (out of 1000)", 
       title="Number of Top 3 Recommended \n Properties Transacted")
```

This figure shows that only 9 out of 1000 consumers in the sample purchase a top 3 search result recommended by Expedia's searching algorithm. 

## Statistical Analysis 1
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
set.seed(15) 
sample_means <- rep(NA, 1000)
n <- nrow(expedia_data_q1) 

for (i in 1:n) {
  sample <- expedia_data_q1 %>% sample_n(size=1000, replace=TRUE)
  sample_means[i] <- as.numeric(sample %>% summarize(mean(trans_made)))
}

sample_means <- tibble(trans_proportion = sample_means) 
quantile(sample_means$trans_proportion, c(0.025, 0.975))
```

Assuming the sample is representative of the population, this question was investigated by using the bootstrapping method. By resampling from the sample of 1,000 and choosing a 95% confidence level, we find that the confidence interval for the proportion of consumers during June $1^{st}$, 2021 and July $31^{st}$, 2021 who purchased a top 3 recommended property is (0.003, 0.015). 

This confidence interval reflects the fact that if we were to repeat the experiment for large number of times, we expect 95% of the confidence intervals generated in a similar manner to ``capture" the true proportion of consumers during June $1^{st}$, 2021 and July $31^{st}$, 2021 is (0.003, 0.015) who purchased a top 3 recommended property. 

The calculated confidence interval has relatively low endpoints of 0.003 and 0.015. Thus, we believe that this proportion can be improved and recommend Expedia to continue to invest time and effort to build a recommendation algorithm that will result in a higher proportion of top 3 recommended properties being purchased. 

## Research Question 2
**Research Question**: Are discounted properties during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021 more likely to result in more clicks? 

**Hypothesis:** 

$H_0: \mu_{discount} - \mu_{no discount} = 0$ 

$H_1: \mu_{discount} - \mu_{no discount} \neq 0$ 

where $\mu_{discount}$ is the mean number of clicks received by discounted properties and $\mu_{no discount}$ is the mean number of clicks received by non-discounted properties during June $1^{st}$, 2021 and July $31^{st}$, 2021. 

**Research Motivation**: 
The population of interest represents all properties listed during June $1^{st}$, 2021 and July $31^{st}$, 2021. Determining whether users are more interested in discounted properties (by using number of clicks as a metric) helps Expedia make strategic decisions. For example, if users are more interested in discounted properties, it may be in Expedia's interest to discount more properties to attract consumers. 

## Visualization 2
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
untidy_expedia_data_q2 <- expedia_data %>% 
  select(num_clicks1, is_drr1, num_clicks2, is_drr2, num_clicks3, is_drr3)

expedia_data_q2 <- tibble(num_clicks=c(NA), is_drr=c(NA))
n <- nrow(untidy_expedia_data_q2)

for (i in 1:n) {
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks1"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr1"]))
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks2"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr2"]))
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks2"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr2"]))
}

expedia_data_q2 <- expedia_data_q2 %>% 
  filter(!is.na(num_clicks) & !is.na(is_drr)) %>% 
  mutate(is_drr = ifelse(is_drr == 1, TRUE, FALSE))

expedia_data_q2_summary <- expedia_data_q2 %>% 
  group_by(is_drr) %>% 
  summarize(mean_num_clicks=mean(num_clicks))
```

## Statistical Analysis 2
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
test_stat <- expedia_data_q2_summary %>%  
  summarize(test_stat=diff(mean_num_clicks)) %>%  
  as.numeric()

set.seed(15) 

n <- nrow(expedia_data_q2)
simulated_values <- rep(NA, n)

for (i in 1:n) {
  simdata <- expedia_data_q2 %>% 
    mutate(is_drr = sample(is_drr)) 
  
  simulated_values[i] <- simdata %>% 
    group_by(is_drr) %>% 
    summarize(mean_num_clicks=mean(num_clicks)) %>%  
    summarize(mean_clicks_diff = diff(mean_num_clicks)) %>%  
    as.numeric()
}

simulated_values <- tibble(mean_clicks_diff = simulated_values) 

more_extreme_simulated_values <- simulated_values %>% 
  filter(abs(mean_clicks_diff) >= abs(test_stat)) %>%  
  summarize(size = n())

p_value <- as.numeric(more_extreme_simulated_values) / n
p_value
```

The calculated test statistic from the dataset for the difference between the mean number of clicks for discounted and non-discounted properties is `r round(test_stat, digits=4)`. This means that within the samples, discounted properties get `r round(test_stat, digits=4)` less clicks than non-discounted properties on average. 

After running 3,000 simulations under the assumption that the null hypothesis is true, the p-value is found to be `r round(p_value, digits=4)`. Since the p-value is between 0.05 and 0.1, there is weak evidence against the null hypothesis. 

We highly recommend Expedia to continue investigating how discounts can affect consumer behaviour in order to develop strategic decisions that will improve Expedia's profitability. 

## Research Question 3
**Research Question**: Do the number of children and adults affect the length of
travel?

**Hypothesis**: 

$H_0: \beta_1 = 0 \text { OR } \beta_2 = 0 \text{ OR } \beta_3 = 0  \text{ OR } ... \  \beta_n = 0$ 

$H_1: \beta_1 \neq 0 \text{ AND } \beta_2 \neq 0 \text{ AND } \beta_3 \neq 0 \text { AND } ... \  \beta_n = 0$ 

where $\beta_1, \beta_2, \beta_3, ... \beta_n$ are slope parameters for the linear regression where the predictor variables are the number of infants, children and adults and the response variable is the time difference between a check-out date and a check-in date (i.e. length of travel). 

**Research Motivation**: As mentioned, Expedia rents properties or charges commissions from hoteliers. Thus, it is crucial to know how long a property should be rented or advise how hotels how to optimize their booking intervals to tailor to consumer's needs. For instance, a hotel with more rooms may way to increase booking intervals if it is found that length of travel is positively correlated with the number of people on the trip. 

## Visualization 3
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
expedia_data_q3 <- expedia_data %>%  
  select(adult_count, child_count, infant_count, checkin_date, checkout_date) %>%  
  filter(!is.na(checkin_date) & !is.na(checkout_date)) %>%  
  mutate(travel_length = as.numeric(checkout_date - checkin_date)) %>%  
  select(adult_count, child_count, travel_length) %>%  
  rowid_to_column()

expedia_data_q3 %>% ggplot(aes(x=adult_count, y=travel_length)) + 
  geom_point() + 
  geom_smooth(se=FALSE, method="lm") + 
  labs(x="Number of Adults",
       y="Average length of Travel (Days)",
       title="Number of Adults Versus \n Average Length of Travel") + 
  theme_minimal()
```


## Statistical Analysis 3 
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
set.seed(15) 
n <- nrow(expedia_data_q3)
training_indices <- sample(1:n, size=round(0.8 * n))
glimpse(expedia_data_q3)

train <- expedia_data_q3 %>% filter(rowid %in% training_indices)
y_train <- train$travel_length
test <- expedia_data_q3 %>% filter(!(rowid %in% training_indices)) 
y_test <- test$travel_length

mod1_train <- lm(travel_length ~ adult_count, data = train) 
mod2_train <- lm(travel_length ~ child_count, data = train) 
mod3_train <- lm(travel_length ~ adult_count + child_count, data = train) 
mod4_train <- lm(travel_length ~ adult_count * child_count, data = train) 

yhat_mod1_test <- predict(mod1_train, newdata = test) 
yhat_mod2_test <- predict(mod2_train, newdata = test) 
yhat_mod3_test <- predict(mod3_train, newdata = test) 
yhat_mod4_test <- predict(mod4_train, newdata = test) 

yhat_mod1_train <- predict(mod1_train, newdata = train)
yhat_mod2_train <- predict(mod2_train, newdata = train) 
yhat_mod3_train <- predict(mod3_train, newdata = train) 
yhat_mod4_train <- predict(mod4_train, newdata = train) 

mod1_test_RMSE <- sqrt(sum((y_test - yhat_mod1_test)^2 / nrow(test)))
mod2_test_RMSE <- sqrt(sum((y_test - yhat_mod2_test)^2 / nrow(test)))
mod3_test_RMSE <- sqrt(sum((y_test - yhat_mod3_test)^2 / nrow(test)))
mod4_test_RMSE <- sqrt(sum((y_test - yhat_mod4_test)^2 / nrow(test)))

mod1_train_RMSE <- sqrt(sum((y_train - yhat_mod1_train)^2 / nrow(train)))
mod2_train_RMSE <- sqrt(sum((y_train - yhat_mod2_train)^2 / nrow(train)))
mod3_train_RMSE <- sqrt(sum((y_train - yhat_mod3_train)^2 / nrow(train)))
mod4_train_RMSE <- sqrt(sum((y_train - yhat_mod4_train)^2 / nrow(train)))

my_table <- tibble(Model = c("1", "2", "3", "4"), 
	                 RMSE_testdata = c(mod1_test_RMSE, mod2_test_RMSE, 
		                                 mod3_test_RMSE, mod4_test_RMSE), 
                   RMSE_traindata = c(mod1_train_RMSE, mod2_train_RMSE, 
                                      mod3_train_RMSE, mod4_train_RMSE),
                   ratio_of_RMSEs = RMSE_testdata / RMSE_traindata)

my_table
summary(mod1_train)$r.squared
```

After trying several linear regression models (e.g. simple, multiple, multiple interactive), we have selected a model that best explains the association between the travellers and the length of the trip. Picking based on good prediction accuracy, low signs of overfitting and simplicity, we find that it is sufficient to only consider how many adults are on a trip when predicting the length of the trip. 

Based on the p-value of `r round(5.546797e-04, digits=6)` which is extremely small, there is strong evidence against the null hypothesis that there is no relationship between the number of adults on a trip and the length of a trip. Thus, we reject the null hypothesis. 

The calculated slope of `r round(0.4257908, digits=4)` implies that for each additional adult, the length of trip increases by `r round(0.4257908, digits=4)` days. With this said, the $R^2$ value of `r round(summary(mod1_train)$r.squared,4)` implies that only `r round(summary(mod1_train)$r.squared,4) * 100`% of variability in the length of trip is accounted by the number of adults on the trip. Certainly, Expedia may choose to continue to explore what variables (along with the number of adults) can better explain the variability in the length of a trip. 

## Limitations 

* The data filled in by users is 100% accurate. Inaccurate data being entered to the search engine will skew statistical results. 

* The sample is representative of the population. If not, statistical models (especially bootstrapping) will not yield accurate results. 

* For the second research question, whether a property is transacted is a better metric compared to the number of clicks a property receives in terms of measuring interest. However, only 9 properties have been transacted out of the 3,000 properties recorded. Due to lack of data, we chose to use the number of clicks as the metric. 

* For the third research question, originally we intended to research how the number of adults, children and _infants_ affect the length of travel. However, only 9 data points had infants in the travel group. Due to insufficient data, we chose to remove the number of infants as a predictor variable. 

## Overall Conclusion - Looking Ahead Part 1
We believe that all 3 research questions have been answered. Here are some closing thoughts for these research questions: 

For the **first research question**, the 95% confidence interval for the proportion of top 3 properties transacted is (0.003, 0.015). While further statistical analysis can be performed to obtain more accurate estimates (e.g. by using larger and more representative datasets), we believe the main takeaway here is that Expedia's recommendation algorithm has room for improvement. Expedia should devote more human resource into research and development of such algorithms to improve the profitability of the business. 

## Overall Conclusion - Looking Ahead Part 2

For the **second research question**, there is weak evidence against the null hypothesis that the mean number of clicks for discounted and non-discounted properties is the same. Unlike the first research question, we recommend Expedia to continue researching how consumer behaviour is affected by discounts as their behaviour directly affects strategic business decisions. Having a better understanding of how discounts affect transactions, Expedia may choose to perform cost and benefit analysis to see how to optimize profits. 

For the **third research question**, it is found that as the number of adults increases, the length of travel increases. However, the $R^2$ value calculated is low. Thus, we recommend Expedia to continue explore how other variables (even the ones that do not appear in the current dataset) affect the length of travel. Expedia may choose to consider this model when purchasing properties in bulk or advising hoteliers regarding expected intervals of consumers. This will improve the likelihood of meeting consumer needs in terms of booking length and may increase the number of properties transacted.
