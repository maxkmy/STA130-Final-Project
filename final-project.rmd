---
title: "Exploring the Expedia Recommendation Algorithm"
author: 'Group 35: Max Ming Yi Koh (1007972785) and Kevin Le (1007952805)'
date: "March 31, 2022"
output:
  beamer_presentation:
    theme: Pittsburgh
    colortheme: orchid
    fonttheme: structurebold
    slide_level: 2
  pdf_document: default
classoption: aspectratio=169
fontsize: 11pt
urlcolor: blue
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# echo=FALSE will stop the code chunk from appearing in the knit document
# warning=FALSE and message=FALSE will stop R messages from appearing in the knit document
library(tidyverse)
library(dplyr)
# here is the data for this project
expedia_data <- read_csv("ExpediaSearchData.csv")
# see the Project Overview page for more information: 
# https://q.utoronto.ca/courses/235890/pages/project-overview
```

## General Motivations and Dataset Description

* Expedia generates revenue by reselling bookings (purchased in bulks at discounted pricing) or charging commissions from hoteliers$^{[1]}$.

* Thus, an effective recommendation algorithm that recognizes consumer needs is crucial to improve user experience and optimize the bottom line of the business.

* This leads to the investigation of the following: 
  1. How effective is Expedia's recommendation algorithm? 
  2. What are some factors that affect purchasing decisions of consumers? 

* The dataset for the research includes data of 1,000 user searches along with certain variables related to users or the top 3 recommended properties during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021.

* Unless stated otherwise, the sample of this research consists of these 1,000 consumer searches while the population of this research consists of all users that made an Expedia search during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021.

## Data Summary
Below is a table of variables used in all 3 research problems. Note that {n} is a placeholder for integers 1, 2, or 3. 
 
| Variable      | Description                                                           |
|---------------|-----------------------------------------------------------------------|
| is_trans{n}   | describes whether the consumer transacted the n-th displayed property |
| is_drr{n}     | describes whether the n-th displayed property is discounted           |
| num_clicks{n} | number of clicks for the n-th displayed property                      |
| checkin_date  | stay start date                                                       |
| checkout_date | stay end date                                                         |
| adult_count   | number of adults on the trip                                          |
| child_count   | number of children on the trip                                        |


## Research Question 1 - Introduction
**Research Question**: What is the proportion of consumers during June $1^{st}$, 2021 and July $31^{st}$, 2021 that purchase one of the top 3 recommended properties? 

**Research Motivation**: 

* The proportion of users who purchase a top 3 recommended property is a good metric to measure the effectiveness of Expedia's recommendation algorithm. 

* For instance, a higher proportion may imply the algorithm is effective at recognizing user needs while a lower proportion may imply the algorithm is less effective at recognizing user needs. 

## Research Question 1 - Data Processing 
* We applied the `select()` function to obtain the required variables, namely is_trans1, is_trans2 and is_trans3. 

* We applied the `mutate()` function to change the values of is_trans1, is_trans2 and is_trans2 based on whether the variable is non-missing and indicated by 0 (no transaction) or 1 (transaction). 

* Lastly, using the redefined is_trans1, is_trans2 and is_trans3 columns, we applied the `mutate()` function to create a new logical variable named trans_made which checks if any of is_trans1, is_trans2 or is_trans3 are set to 1.

## Research Question 1 - Data Visualization
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
expedia_data_q1 <- expedia_data %>% 
  select(is_trans1, is_trans2, is_trans3) %>% 
  mutate(is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0),
         is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0),
         is_trans1 = ifelse(!is.na(is_trans1) & is_trans1 == 1, 1, 0), 
         trans_made = ifelse(is_trans1 + is_trans2 + is_trans3 > 0, TRUE, FALSE)
  ) 

expedia_data_q1 %>%  
  ggplot(aes(x=trans_made)) + 
  geom_bar(color="black", fill="gray") + 
  labs(x="Transaction made by users for any \n of top 3 recommended properties",
       y="Count", 
       title="Number of users who have transacted \nor have not transacted top 3 \nrecommended properties out of \n1,000 users")
```

This figure shows that 9 out of 1,000 consumers in the sample purchase a top 3 search result recommended by Expedia's searching algorithm. 

## Research Question 1 - Statistical Analysis
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
set.seed(15) 
n <- 3000
sample_means <- rep(NA, 3000)

for (i in 1:n) {
  sample <- expedia_data_q1 %>% sample_n(size=1000, replace=TRUE)
  sample_means[i] <- as.numeric(sample %>% summarize(mean(trans_made)))
}

sample_means <- tibble(trans_proportion = sample_means) 
quantile(sample_means$trans_proportion, c(0.025, 0.975))
```

* We assume that the sample is representative of the population in order to perform bootstrapping. 

* By resampling from the sample of 1,000 users for 3,000 times and choosing a 95% confidence level, we find the confidence interval for the proportion of users during June $1^{st}$, 2021 and July $31^{st}$, 2021 who purchased a top 3 recommended property is (0.003, 0.015).
  
* A confidence level 95% means that 95% of confidence interval generated in a similar manner (i.e. same 1,000 user data and 3,000 repetitions) will capture the true proportion of consumers during June $1^{st}$, 2021 and July $31^{st}$, 2021 who purchased a top 3 recommended property.

* The calculated confidence interval (i.e. $0.015 - 0.003 = 0.012$) is very narrow. This means we expect the true true proportion to be very similar to the estimate made. 

## Research Question 2 - Introduction
**Research Question**: Are discounted properties during the period of June $1^{st}$, 2021 and July $31^{st}$, 2021 more likely to result in more clicks? 

**Hypothesis:** 

$H_0: \mu_{no\ discount} - \mu_{discount} = 0$ 

$H_1: \mu_{no\ discount} - \mu_{discount} \neq 0$ 

where $\mu_{discount}$ is the mean number of clicks received by discounted properties and $\mu_{no\ discount}$ is the mean number of clicks received by non-discounted properties during June $1^{st}$, 2021 and July $31^{st}$, 2021. 

**Research Motivation**: 

* Here, the population of interest consists of all properties listed during June $1^{st}$, 2021 and July $31^{st}$, 2021. 

* Determining whether users are more interested in discounted properties (by using number of clicks as a metric for interest) helps Expedia make strategic decisions. 

* For instance, if users are more interested in discounted properties, it may be in Expedia's interest to discount more properties to attract consumers. 

## Research Question 2 - Data Processing
* We applied the `select()` function to obtain the required variables, namely num_clicks1, num_clicks2, num_clicks3, is_drr1, is_drr2 and is_drr3. 

* To tidy the data (due to change in population), we ran a for loop to reshape the tibble to have rows which represent individual listings. The new tibble has variables num_clicks and is_drr. 

* We applied the `filter()` function to remove listings where num_clicks or is_drr are missing. 

* We applied the `mutate()` function to make is_drr a logical variable. 

* We applied the `group_by()` and `summarise` functions to obtain the mean number of clicks for discounted and non-discounted listings. 

## Research Question 2 - Visualization
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
untidy_expedia_data_q2 <- expedia_data %>% 
  select(num_clicks1, is_drr1, num_clicks2, is_drr2, num_clicks3, is_drr3)

expedia_data_q2 <- tibble(num_clicks=c(NA), is_drr=c(NA))
n <- nrow(untidy_expedia_data_q2)

for (i in 1:n) {
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks1"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr1"]))
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks2"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr2"]))
  expedia_data_q2 <- add_row(expedia_data_q2, 
                             num_clicks = as.numeric(untidy_expedia_data_q2[i, "num_clicks2"]),
                             is_drr = as.numeric(untidy_expedia_data_q2[i, "is_drr2"]))
}

expedia_data_q2 <- expedia_data_q2 %>% 
  filter(!is.na(num_clicks) & !is.na(is_drr)) %>% 
  mutate(is_drr = ifelse(is_drr == 1, TRUE, FALSE))

expedia_data_q2_summary <- expedia_data_q2 %>% 
  group_by(is_drr) %>% 
  summarise(mean_num_clicks=mean(num_clicks))

expedia_data_q2_summary %>% 
  ggplot(aes(x=is_drr, y=mean_num_clicks)) + 
  geom_bar(stat="identity") + 
  labs(x="Property Discounted",
       y="Average Number of Clicks",
       title="Average Number of Clicks for Discounted \n and Non-discounted properties")
```

## Research Question 2 - Statistical Analysis
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
test_stat <- expedia_data_q2_summary %>%  
  summarize(test_stat=diff(mean_num_clicks)) %>%  
  as.numeric()

set.seed(15) 

n <- 5000
simulated_values <- rep(NA, nrow(expedia_data_q2))

for (i in 1:n) {
  simdata <- expedia_data_q2 %>% 
    mutate(is_drr = sample(is_drr)) 
  
  simulated_values[i] <- simdata %>% 
    group_by(is_drr) %>% 
    summarize(mean_num_clicks=mean(num_clicks)) %>%  
    summarize(mean_clicks_diff = diff(mean_num_clicks)) %>%  
    as.numeric()
}

simulated_values <- tibble(mean_clicks_diff = simulated_values) 

more_extreme_simulated_values <- simulated_values %>% 
  filter(abs(mean_clicks_diff) >= abs(test_stat)) %>%  
  summarize(size = n())

p_value <- as.numeric(more_extreme_simulated_values) / n
p_value
```

* The calculated test statistic from the dataset for the difference between the mean number of clicks for discounted and non-discounted properties is `r round(test_stat, digits=4)`. 

* This means that within the samples, discounted properties get `r round(test_stat, digits=4)` less clicks than non-discounted properties on average. 

* After running 5,000 simulations under the assumption that the null hypothesis is true, the p-value is found to be `r round(p_value, digits=4)`. 

* Since the p-value is between 0.01 and 0.05, there is moderate evidence against the null hypothesis which states that the mean number of clicks for discounted and non-discounted properties is the same. 

## Research Question 3 - Introduction
**Research Question**: Do the number of children and adults affect the length of
travel?

**Hypothesis**: 

$H_0: \beta_1 = 0 \text { OR } \beta_2 = 0 \text{ OR }... \  \beta_n = 0$ 

$H_1: \beta_1 \neq 0 \text{ AND } \beta_2 \neq 0 \text{ AND }... \  \beta_n \neq 0$ 

where $\beta_1, \ \beta_2, \ ..., \ \beta_n$ are slope parameters for the linear regression where the predictor variables are the number of infants, children and adults and the response variable is the time difference between a check-out date and a check-in date (i.e. length of travel). 

**Research Motivation**: 

* As mentioned, Expedia rents properties or charges commissions from hoteliers.

* Thus, knowing how long a property should be rented or advising how hotels should schedule booking intervals to tailor consumer needs is important. 

* For instance, a property with more rooms can fit more travelers. If it is found that length of travel is positively correlated with the number of people on a trip, then the property should expect for longer booking intervals. 

## Research Question 3 - Data Processing 

* We applied the `select()` function to obtain the required variables, namely adult_count, child_count, checkin_date, checkout_date. 

* We applied the `filter()` function to remove rows where checkin_date or checkout_date are missing. 

* We applied the `mutate()` function to create a new variable called travel_length which represents the time difference between checkout_date and checkin_date in days. 

* We applied the `select()` function to select the required variables, namely adult_count, child_count and travel_length. 

* To perform linear regression, we applied the `rowid_to_column()` function to add a unique identifier to each row. 

## Research Question 3 - Visualization
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='center'}
expedia_data_q3 <- expedia_data %>%  
  select(adult_count, child_count, checkin_date, checkout_date) %>%  
  filter(!is.na(checkin_date) & !is.na(checkout_date)) %>%  
  mutate(travel_length = as.numeric(checkout_date - checkin_date)) %>%  
  select(adult_count, child_count, travel_length) %>%  
  rowid_to_column()

expedia_data_q3 %>% ggplot(aes(x=adult_count, y=travel_length)) + 
  geom_point() + 
  geom_smooth(se=FALSE, method="lm") + 
  labs(x="Number of Adults",
       y="Average length of Travel (Days)",
       title="Number of Adults Versus \nAverage Length of Travel") + 
  theme_minimal()
```


## Research Question 3 - Statistical Analysis
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=4, fig.align='left', results="hide"}
set.seed(15) 
n <- nrow(expedia_data_q3)
training_indices <- sample(1:n, size=round(0.8 * n))
glimpse(expedia_data_q3)

train <- expedia_data_q3 %>% filter(rowid %in% training_indices)
y_train <- train$travel_length
test <- expedia_data_q3 %>% filter(!(rowid %in% training_indices)) 
y_test <- test$travel_length

mod1_train <- lm(travel_length ~ adult_count, data = train) 
mod2_train <- lm(travel_length ~ child_count, data = train) 
mod3_train <- lm(travel_length ~ adult_count + child_count, data = train) 
mod4_train <- lm(travel_length ~ adult_count * child_count, data = train) 

yhat_mod1_test <- predict(mod1_train, newdata = test) 
yhat_mod2_test <- predict(mod2_train, newdata = test) 
yhat_mod3_test <- predict(mod3_train, newdata = test) 
yhat_mod4_test <- predict(mod4_train, newdata = test) 

yhat_mod1_train <- predict(mod1_train, newdata = train)
yhat_mod2_train <- predict(mod2_train, newdata = train) 
yhat_mod3_train <- predict(mod3_train, newdata = train) 
yhat_mod4_train <- predict(mod4_train, newdata = train) 

mod1_test_RMSE <- sqrt(sum((y_test - yhat_mod1_test)^2 / nrow(test)))
mod2_test_RMSE <- sqrt(sum((y_test - yhat_mod2_test)^2 / nrow(test)))
mod3_test_RMSE <- sqrt(sum((y_test - yhat_mod3_test)^2 / nrow(test)))
mod4_test_RMSE <- sqrt(sum((y_test - yhat_mod4_test)^2 / nrow(test)))

mod1_train_RMSE <- sqrt(sum((y_train - yhat_mod1_train)^2 / nrow(train)))
mod2_train_RMSE <- sqrt(sum((y_train - yhat_mod2_train)^2 / nrow(train)))
mod3_train_RMSE <- sqrt(sum((y_train - yhat_mod3_train)^2 / nrow(train)))
mod4_train_RMSE <- sqrt(sum((y_train - yhat_mod4_train)^2 / nrow(train)))

my_table <- tibble(Model = c("1", "2", "3", "4"), 
	                 RMSE_testdata = c(mod1_test_RMSE, mod2_test_RMSE, 
		                                 mod3_test_RMSE, mod4_test_RMSE), 
                   RMSE_traindata = c(mod1_train_RMSE, mod2_train_RMSE, 
                                      mod3_train_RMSE, mod4_train_RMSE),
                   ratio_of_RMSEs = RMSE_testdata / RMSE_traindata)

my_table
summary(mod1_train)$r.squared
summary(mod2_train)$r.squared
summary(mod3_train)$r.squared
summary(mod4_train)$r.squared
```

* After trying several linear regression models (e.g. simple, multiple regression with or without interaction), we have found a model that best explains the association between the number and type of travelers and length of the trip. 

* By picking model based on prediction accuracy, low signs of overfitting and simplicity, we find it is sufficient to only consider how many adults are on a trip to predict the length of the trip. 

* Based on the p-value of `r round(5.546797e-04, digits=6)` which is extremely small, there is very strong evidence against the null hypothesis that there is no relationship between the number of adults on a trip and the length of a trip. Due to the extremely small p-value, we can reject the null hypothesis. 

* The calculated slope of `r round(0.4257908, digits=4)` implies that for each additional adult, the length of trip increases by `r round(0.4257908, digits=4)` days on average. 

* With this said, the $R^2$ value of `r round(summary(mod1_train)$r.squared,4)` implies that only `r round(summary(mod1_train)$r.squared,4) * 100`% of variability in the length of trip is accounted by the number of adults on the trip. 

## Limitations 

* The data filled in by users is 100% accurate. Inaccurate data being entered to the search engine will skew statistical results. 

* The sample is representative of the population. If not, statistical models (especially bootstrapping) will not yield accurate results. 

* For the second research question, whether a property is transacted is a better metric compared to the number of clicks a property receives in terms of measuring interest. However, only 9 properties have been transacted out of the 3,000 properties recorded. Due to lack of data, we chose to use the number of clicks as the metric. 

* For the third research question, originally we intended to research how the number of adults, children and _infants_ affect the length of travel. However, only 9 data points had infants in the travel group. Due to insufficient data, we chose to remove the number of infants as a potential predictor variable. 

## Overall Conclusion - Looking Ahead Part 1
Here are some closing thoughts to each individual research question.

For the **first research question**, 

* The 95% confidence interval for the proportion of top 3 recommended listings transacted is (0.003, 0.015). 

* The bounds of the interval are low which implies the recommendation has much room for improvement. We recommend Expedia to invest in research and development of recommendation algorithms which directly improves the profitability of the business. 

For the **second research question**, 

* It was found that there is weak evidence against the null hypothesis that the mean number of clicks for discounted and non-discounted properties is the same. 

* We recommend Expedia to perform A/B testing with variation of your website with more or less discounted properties to see how users consumption behaviour changes$^{[2]}$. 

* This may lead to developing new strategic business decisions in terms of increasing or decreasing the number of discounted properties on the webpage.  

## Overall Conclusion - Looking Ahead Part 2

For the **third research question**, 

* It is found that as the number of adults increases, the length of travel increases. 

* Expedia can consider this model when purchases properties in bulk or advising hoteliers regarding the expected interval of booking. 

* However, the low $R^2$ value implies there are other variables that explain the variability in travel length. To get a more "complete" model, Expedia may choose to continue to explore how other variables (including variables that do not appear in the current dataset) affect length of travel. 

## Citations 

1. https://www.nasdaq.com/articles/how-expedia-makes-most-its-money-2017-08-28

2. https://vwo.com/ab-testing/
